apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "data-ingestion-service.fullname" . }}
  labels:
    {{- include "data-ingestion-service.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.dataIngestionService.replicas }}
  selector:
    matchLabels:
      {{- include "data-ingestion-service.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "data-ingestion-service.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: {{ .Values.dataIngestionService.restartPolicy }}
      {{- if .Values.dataIngestionService.useSasl }}
      initContainers:
      - name: generate-jaas-config
        image: busybox:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            mkdir -p /etc/kafka/secrets
            cat > /etc/kafka/secrets/kafka_client_jaas.conf <<EOF
            KafkaClient {
              org.apache.kafka.common.security.plain.PlainLoginModule required
              username="${AKTO_KAFKA_USERNAME}"
              password="${AKTO_KAFKA_PASSWORD}";
            };
            EOF
            echo "Kafka client JAAS config generated successfully"
        env:
        {{- if .Values.dataIngestionService.kafka.useSecretsForSaslCredentials }}
        - name: AKTO_KAFKA_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.existingSecret }}
              key: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.username }}
        - name: AKTO_KAFKA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.existingSecret }}
              key: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.password }}
        {{- else }}
        - name: AKTO_KAFKA_USERNAME
          value: {{ quote .Values.dataIngestionService.kafka.saslUsername }}
        - name: AKTO_KAFKA_PASSWORD
          value: {{ quote .Values.dataIngestionService.kafka.saslPassword }}
        {{- end }}
        volumeMounts:
        - name: kafka-jaas-config
          mountPath: /etc/kafka/secrets
      {{- end }}
      containers:
      - name: data-ingestion-service
        image: {{ .Values.dataIngestionService.image.repository }}@{{ .Values.dataIngestionService.image.digest }}
        imagePullPolicy: {{ .Values.dataIngestionService.imagePullPolicy }}
        ports:
        - containerPort: {{ .Values.dataIngestionService.service.targetPort }}
          protocol: TCP
        env:
        - name: AKTO_TRAFFIC_BATCH_SIZE
          value: {{ quote .Values.dataIngestionService.env.aktoTrafficBatchSize }}
        - name: AKTO_TRAFFIC_BATCH_TIME_SECS
          value: {{ quote .Values.dataIngestionService.env.aktoTrafficBatchTimeSecs }}
        - name: AKTO_KAFKA_BROKER_URL
          value: {{ quote .Values.dataIngestionService.env.aktoKafkaBrokerUrl }}
        - name: AKTO_KAFKA_PRODUCER_BATCH_SIZE
          value: {{ quote .Values.dataIngestionService.env.aktoKafkaProducerBatchSize }}
        - name: AKTO_KAFKA_PRODUCER_LINGER_MS
          value: {{ quote .Values.dataIngestionService.env.aktoKafkaProducerLingerMs }}
        - name: AKTO_KAFKA_TOPIC_NAME
          value: {{ quote .Values.dataIngestionService.env.aktoKafkaTopicName }}
        - name: AKTO_LOG_LEVEL
          value: {{ quote .Values.dataIngestionService.env.aktoLogLevel }}
        - name: KUBERNETES_CLUSTER_DOMAIN
          value: {{ quote .Values.kubernetesClusterDomain }}
        {{- if .Values.dataIngestionService.useSasl }}
        - name: KAFKA_OPTS
          value: "-Djava.security.auth.login.config=/etc/kafka/secrets/kafka_client_jaas.conf"
        - name: AKTO_KAFKA_SASL_MECHANISM
          value: "PLAIN"
        - name: AKTO_KAFKA_SECURITY_PROTOCOL
          value: "SASL_PLAINTEXT"
        {{- if and .Values.dataIngestionService.useSasl .Values.dataIngestionService.kafka.useSecretsForSaslCredentials }}
        - name: AKTO_KAFKA_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.existingSecret }}
              key: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.username }}
        - name: AKTO_KAFKA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.existingSecret }}
              key: {{ .Values.dataIngestionService.kafka.saslCredentialsSecrets.password }}
        {{- else }}
        - name: AKTO_KAFKA_USERNAME
          value: {{ quote .Values.dataIngestionService.kafka.saslUsername }}
        - name: AKTO_KAFKA_PASSWORD
          value: {{ quote .Values.dataIngestionService.kafka.saslPassword }}
        {{- end }}
        {{- end }}
        resources:
          {{- toYaml .Values.dataIngestionService.resources | nindent 10 }}
        {{- if .Values.dataIngestionService.useSasl }}
        volumeMounts:
        - name: kafka-jaas-config
          mountPath: /etc/kafka/secrets
        {{- end }}
      {{- if .Values.dataIngestionService.useSasl }}
      volumes:
      - name: kafka-jaas-config
        emptyDir: {}
      {{- end }}
